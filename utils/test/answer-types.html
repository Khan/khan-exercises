<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>answer-types</title>
    <!-- Include dependencies -->
    <script src="../../local-only/jquery.js"></script>
    <script src="../../local-only/jed.js"></script>
    <script src="../../local-only/i18n.js"></script>
    <script src="../../local-only/localeplanet/icu.en-US.js"></script>
    <script>
        // TODO(alpert): Ugh, should probably load khan-exercise.js for real...
        var Khan = {
            query: {},
            scriptWait: $.noop,

            // This is a random number pulled out of my 32-bit
            // pseudo-random hat so that tests are always the same
            randomSeed: 0x4e27b400
        };
        var KhanUtil = Khan.Util = {
            debugLog: $.noop,
            random: function() {
                // Robert Jenkins' 32 bit integer hash function.
                var seed = Khan.randomSeed;
                seed = ((seed + 0x7ed55d16) + (seed << 12)) & 0xffffffff;
                seed = ((seed ^ 0xc761c23c) ^ (seed >>> 19)) & 0xffffffff;
                seed = ((seed + 0x165667b1) + (seed << 5)) & 0xffffffff;
                seed = ((seed + 0xd3a2646c) ^ (seed << 9)) & 0xffffffff;
                seed = ((seed + 0xfd7046c5) + (seed << 3)) & 0xffffffff;
                seed = ((seed ^ 0xb55a4f09) ^ (seed >>> 16)) & 0xffffffff;
                return (Khan.randomSeed = (seed & 0xfffffff)) / 0x10000000;
            },
            localeToFixed: function(num, places) {
                var decimal = icu.getDecimalFormatSymbols().decimal_separator;
                return num.toFixed(places).replace(".", decimal);
            }
        };
        $.fn.runModules = function() {
            $.fn.tmpl.apply(this, arguments);
            $.fn.tex.apply(this, arguments);
            return this;
        };
    </script>
    <script src="../../local-only/underscore.js"></script>
    <script src="../../third_party/MathJax/2.1/MathJax.js?config=KAthJax-da9a7f53e588f3837b045a600e1dc439"></script>
    <script src="../../local-only/katex/katex.js"></script>

    <!-- Include QUnit -->
    <link rel="stylesheet" href="../../test/qunit/qunit/qunit.css" type="text/css" media="screen">
    <script src="../../test/qunit/qunit/qunit.js"></script>

    <!-- Include utility files and tests. -->
    <script src="../../exercises-stub.js"></script>
    <script src="../math.js"></script>
    <script src="../tex.js"></script>
    <script src="../tmpl.js"></script>
    <script src="../answer-types.js"></script>
</head>
<body>

<h1 id="qunit-header">answer-types</h1>
<h2 id="qunit-banner"></h2>
<div id="qunit-testrunner-toolbar"></div>
<h2 id="qunit-userAgent"></h2>
<ol id="qunit-tests"></ol>

<div id="qunit-fixture">
    <div id="solutionarea">
    </div>
    <div class="problem">
    </div>
</div>

<script>
(function() {

    /**
     * Return a promise that gets resolved after 1 ms
     */
    function defer() {
        var deferred = $.Deferred();
        _.defer(deferred.resolve);
        return deferred.promise();
    }

    function testAnswer(answerData, input, result, description) {
        $("#solutionarea input").val(input);
        checkAnswer(answerData, result, description + " [" + input + "]");
    }

    function testMultipleAnswer(answerData, inputs, result, description) {
        _.chain($("#solutionarea input")).zip(inputs).each(function(args) {
            var el = args[0], text = args[1];
            if (typeof text === "string") {
                $(el).val(text);
            } else {
                $(el).prop("checked", text);
            }
        });
        checkAnswer(
            answerData, result, description + " [" + inputs.join(", ") + "]");
    }

    function checkAnswer(answerData, result, description) {
        var validator = answerData.validator;
        var getAnswer = answerData.answer;

        var answer = validator(getAnswer());
        if (result === "right") {
            strictEqual(answer.empty, false, description + " - not empty");
            strictEqual(answer.message, null, description + " - no message");
            strictEqual(answer.correct, true, description + " - correct");
        } else if (result === "right-message") {
            strictEqual(answer.empty, false, description + " - not empty");
            notStrictEqual(answer.message, null, description + " - message");
            strictEqual(answer.correct, true, description + " - correct");
        } else if (result === "wrong") {
            strictEqual(answer.empty, false, description + " - not empty");
            strictEqual(answer.message, null, description + " - no message");
            strictEqual(answer.correct, false, description + " - not correct");
        } else if (result === "wrong-message") {
            strictEqual(answer.empty, false, description + " - not empty");
            notStrictEqual(answer.message, null, description + " - message");
            strictEqual(answer.correct, false, description + " - not correct");
        } else if (result === "empty") {
            strictEqual(answer.empty, true, description + " - empty");
            strictEqual(answer.message, null, description + " - no message");
            strictEqual(answer.correct, false, description + " - not correct");
        } else if (result === "empty-message") {
            strictEqual(answer.empty, true, description + " - empty");
            notStrictEqual(answer.message, null, description + " - message");
            strictEqual(answer.correct, false, description + " - not correct");
        }
    }

    asyncTest("number integer", 24, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='number' data-forms='integer'>-42<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "", "empty", "empty answer is empty");
        testAnswer(answerData, "123", "wrong", "wrong answer is wrong");
        testAnswer(answerData, "-42", "right", "right answer is right");
        testAnswer(answerData, "-84/2", "wrong", "non-integer right answer is wrong");
        testAnswer(answerData, " \u2212 42 ", "right", "weirdly formatted right answer is right");
        testAnswer(answerData, "- 4 2", "wrong", "crazily formatted answer is wrong");
        testAnswer(answerData, "-41.9999999", "wrong", "close decimal is wrong");
        testAnswer(answerData, "-,42", "wrong", "sort of tricky wrong answer is wrong");

        start();
    });

    asyncTest("number big integer", 18, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='number' data-forms='integer'>12345678<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "12345670", "wrong", "wrong answer is wrong");
        testAnswer(answerData, "12345678", "right", "right answer is right");
        testAnswer(answerData, "12,345,678", "right", "right answer with commas is right");
        testAnswer(answerData, "12.345.678", "right", "right answer with periods is right");
        testAnswer(answerData, "12 345 678", "right", "right answer with spaces is right");
        testAnswer(answerData, "123 45 678", "wrong", "right answer with wrong commas is wrong");

        start();
    });

    asyncTest("number proper", 15, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='number' data-forms='proper'>-0.5<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "1/2", "wrong", "wrong answer is wrong");
        testAnswer(answerData, "-1/2", "right", "right answer is right");
        testAnswer(answerData, "-2/4", "empty-message", "unsimplified right answer provides a message");
        testAnswer(answerData, " \u2212 1 / 2 ", "right", "weirdly formatted right answer is right");
        testAnswer(answerData, "-0.5", "wrong", "decimal is wrong");

        start();
    });

    asyncTest("number proper (enforced simplification)", 15, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='number' data-forms='proper' " +
            "data-simplify='enforced'>-0.5<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "1/2", "wrong", "wrong answer is wrong");
        testAnswer(answerData, "-1/2", "right", "right answer is right");
        testAnswer(answerData, "-2/4", "wrong-message", "unsimplified right answer provides a message");
        testAnswer(answerData, " \u2212 1 / 2 ", "right", "weirdly formatted right answer is right");
        testAnswer(answerData, "-0.5", "wrong", "decimal is wrong");

        start();
    });

    asyncTest("number proper (unsimplified)", 15, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='number' data-forms='proper' " +
            "data-simplify='optional'>-0.5<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "1/2", "wrong", "wrong answer is wrong");
        testAnswer(answerData, "-1/2", "right", "right answer is right");
        testAnswer(answerData, "-2/4", "right", "unsimplified right answer is right");
        testAnswer(answerData, " \u2212 1 / 2 ", "right", "weirdly formatted right answer is right");
        testAnswer(answerData, "-0.5", "wrong", "decimal is wrong");

        start();
    });

    asyncTest("number improper", 18, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='number' data-forms='improper'>-1.5<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "3/2", "wrong", "wrong answer is wrong");
        testAnswer(answerData, "-3/2", "right", "right answer is right");
        testAnswer(answerData, "-6/4", "empty-message", "unsimplified right answer provides a message");
        testAnswer(answerData, " \u2212 3 / 2 ", "right", "weirdly formatted right answer is right");
        testAnswer(answerData, "-1.5", "wrong", "decimal is wrong");
        testAnswer(answerData, "-1 1/2", "wrong", "mixed number is wrong");

        start();
    });

    asyncTest("number improper (enforced simplification)", 18, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='number' data-forms='improper' " +
            "data-simplify='enforced'>-1.5<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "3/2", "wrong", "wrong answer is wrong");
        testAnswer(answerData, "-3/2", "right",  "right answer is right");
        testAnswer(answerData, "-6/4", "wrong-message", "unsimplified right answer provides a message");
        testAnswer(answerData, " \u2212 3 / 2 ", "right",  "weirdly formatted right answer is right");
        testAnswer(answerData, "-1.5", "wrong", "decimal is wrong");
        testAnswer(answerData, "-1 1/2", "wrong", "mixed number is wrong");

        start();
    });

    asyncTest("number improper (unsimplified)", 18, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='number' data-forms='improper' " +
            "data-simplify='optional'>-1.5<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "3/2", "wrong", "wrong answer is wrong");
        testAnswer(answerData, "-3/2", "right",  "right answer is right");
        testAnswer(answerData, "-6/4", "right",  "unsimplified right answer is right");
        testAnswer(answerData, " \u2212 3 / 2 ", "right",  "weirdly formatted right answer is right");
        testAnswer(answerData, "-1.5", "wrong", "decimal is wrong");
        testAnswer(answerData, "-1 1/2", "wrong", "mixed number is wrong");

        start();
    });

    asyncTest("number pi", 30, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='number' data-forms='pi'>-6.283185307179586<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "2pi", "wrong", "wrong answer is wrong");
        testAnswer(answerData, "-2pi", "right", "right answer is right");
        testAnswer(answerData, "-tau", "right", "right answer is right");
        testAnswer(answerData, "-2tau", "wrong", "tau is not pi");
        testAnswer(answerData, "-2", "wrong", "pi is not 1");
        testAnswer(answerData, "-6.28", "empty-message", "approximately right answer provides a message");
        testAnswer(answerData, "-44/7", "empty-message", "approximately right answer provides a message");
        testAnswer(answerData, "" + (-2 * Math.PI), "empty-message", "approximately right answer provides a message");
        testAnswer(answerData, "-2/1 pi", "empty-message", "unsimplified answer provides a message");
        testAnswer(answerData, "-9.42", "wrong", "totally wrong answer gives no message");

        start();
    });

    asyncTest("number pi (rational)", 42, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='number' data-forms='pi'>-2.6179938779914944<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "5pi/6", "wrong", "wrong answer is wrong");
        testAnswer(answerData, "-5/6pi", "right", "right answer is right");
        testAnswer(answerData, "-5/12tau", "right", "right answer is right");
        testAnswer(answerData, "-5pi/6", "right", "right answer is right");
        testAnswer(answerData, "-5tau/12", "right", "right answer is right");
        testAnswer(answerData, "-2.62", "empty-message", "approximately right answer provides a message");
        testAnswer(answerData, " \u2212 5 \u03c0 / 6 ", "right", "weirdly formatted right answer is right");
        testAnswer(answerData, " \u2212 5 \u03c4 / 12 ", "right", "weirdly formatted right answer is right");
        testAnswer(answerData, " 5 \u03c0 / \u2212 6 ", "empty-message", "negative in denominator provides a message");
        testAnswer(answerData, " 5 \u03c4 / \u2212 12 ", "empty-message", "negative in denominator provides a message");
        testAnswer(answerData, " \u2212 5 / 6 \u03c0 ", "right", "weirdly formatted right answer is right");
        testAnswer(answerData, " \u2212 5 / 12 \u03c4 ", "right", "weirdly formatted right answer is right");
        testAnswer(answerData, " 5 / \u2212 6 \u03c0 ", "empty-message", "negative in denominator provides a message");
        testAnswer(answerData, " 5 / \u2212 12 \u03c4 ", "empty-message", "negative in denominator provides a message");

        start();
    });

    asyncTest("number pi (rational > 1)", 21, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='number' data-forms='pi'>-15.184364492350666<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "4 5pi/6", "wrong", "wrong answer is wrong");
        testAnswer(answerData, "-4 5/6pi", "right", "right answer is right");
        testAnswer(answerData, "-29/6pi", "right", "right answer is right");
        testAnswer(answerData, "-2 5/12tau", "right", "right answer is right");
        testAnswer(answerData, "-15.18", "empty-message", "approximately right answer provides a message");
        testAnswer(answerData, " \u2212 4 5 / 6 \u03c0 ", "right", "weirdly formatted right answer is right");
        testAnswer(answerData, " \u2212 2 5 / 12 \u03c4 ", "right", "weirdly formatted right answer is right");

        start();
    });

    asyncTest("number pi (decimal)", 18, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='number' data-forms='pi'>-1.5707963267948966<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "0.5 pi", "wrong", "wrong answer is wrong");
        testAnswer(answerData, "-0.5pi", "right", "right answer is right");
        testAnswer(answerData, "-0.25tau", "right", "right answer is right");
        testAnswer(answerData, "-1.57", "empty-message", "approximately right answer provides a message");
        testAnswer(answerData, " \u2212 0.5 \u03c0 ", "right", "weirdly formatted right answer is right");
        testAnswer(answerData, " \u2212 0.25 \u03c4 ", "right", "weirdly formatted right answer is right");

        start();
    });

    asyncTest("number log", 9, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='number' data-forms='log'>2<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "2", "wrong", "wrong answer is wrong");
        testAnswer(answerData, "log(2)", "right", "right answer is right");
        testAnswer(answerData, " log ( 2 ) ", "right", "weirdly formatted right answer is right");

        start();
    });

    asyncTest("number percent", 9, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='number' data-forms='percent'>0.42<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "0.42", "wrong", "wrong answer is wrong");
        testAnswer(answerData, "42%", "right", "right answer is right");
        testAnswer(answerData, "42", "wrong-message", "leaving off percent sign provides a message");

        start();
    });

    asyncTest("number mixed", 18, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='number' data-forms='mixed'>-1.5<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "1 1/2", "wrong", "wrong answer is wrong");
        testAnswer(answerData, "-1 1/2", "right", "right answer is right");
        testAnswer(answerData, "-1 2/4", "empty-message", "unsimplified right answer provides a message");
        testAnswer(answerData, " \u2212 1 1 / 2 ", "right", "weirdly formatted right answer is right");
        testAnswer(answerData, "-1.5", "wrong", "decimal is wrong");
        testAnswer(answerData, "-3/2", "wrong", "improper fraction is wrong");

        start();
    });

    asyncTest("number mixed (simplification enforced)", 18, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='number' data-forms='mixed' " +
            "data-simplify='enforced'>-1.5<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "1 1/2", "wrong", "wrong answer is wrong");
        testAnswer(answerData, "-1 1/2", "right",  "right answer is right");
        testAnswer(answerData, "-1 2/4", "wrong-message", "unsimplified right answer provides a message");
        testAnswer(answerData, " \u2212 1 1 / 2 ", "right",  "weirdly formatted right answer is right");
        testAnswer(answerData, "-1.5", "wrong", "decimal is wrong");
        testAnswer(answerData, "-3/2", "wrong", "improper fraction is wrong");

        start();
    });

    asyncTest("number mixed (unsimplified)", 18, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='number' data-forms='mixed' " +
            "data-simplify='optional'>-1.5<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "1 1/2", "wrong", "wrong answer is wrong");
        testAnswer(answerData, "-1 1/2", "right",  "right answer is right");
        testAnswer(answerData, "-1 2/4", "right",  "unsimplified right answer is right");
        testAnswer(answerData, " \u2212 1 1 / 2 ", "right",  "weirdly formatted right answer is right");
        testAnswer(answerData, "-1.5", "wrong", "decimal is wrong");
        testAnswer(answerData, "-3/2", "wrong", "improper fraction is wrong");

        start();
    });

    asyncTest("number decimal", 27, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='number' data-forms='decimal'>12345.6789<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "12345.6788", "wrong", "wrong answer is wrong");
        testAnswer(answerData, "12345.6789", "right", "right answer is right");
        testAnswer(answerData, "12345,6789", "right", "right answer with decimal comma is right");
        testAnswer(answerData, "12,345.6789", "right", "right answer with commas is right");
        testAnswer(answerData, "12,345.678,9", "right", "right answer with commas is right");
        testAnswer(answerData, "12.345,6789", "right", "right answer with periods is right");
        testAnswer(answerData, "12.345,678.9", "right", "right answer with periods is right");
        testAnswer(answerData, "12 345.678 9", "right", "right answer with spaces is right");
        testAnswer(answerData, "12 345,678 9", "right", "right answer with spaces is right");

        start();
    });

    asyncTest("number leading zeros are okay on decimals", 3, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='number'>0.372<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "0.372", "right", "right answer is right");

        start();
    });

    asyncTest("number leading zeros are not okay on integers", 12, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='number'>372<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "372", "right", "right answer is right");
        testAnswer(answerData, "0.372", "wrong", "leading zeros are wrong");
        testAnswer(answerData, "00.372", "wrong", "two leading zeros are wrong");
        testAnswer(answerData, "0.000.372", "wrong", "many leading zeros are wrong");

        start();
    });

    asyncTest("number inexact", 12, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='number' data-inexact data-max-error='1'>123.45<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "125", "wrong", "wrong answer is wrong");
        testAnswer(answerData, "123.45", "right", "exact answer is right");
        testAnswer(answerData, "124.4", "right", "high answer is right");
        testAnswer(answerData, "122.5", "right", "low answer is right");

        start();
    });

    asyncTest("number max-error-only", 12, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='number' data-max-error='1'>123.45<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "125", "wrong", "wrong answer is wrong");
        testAnswer(answerData, "123.45", "right", "exact answer is right");
        testAnswer(answerData, "124.4", "wrong", "high answer is wrong");
        testAnswer(answerData, "122.5", "wrong", "low answer is wrong");

        start();
    });

    asyncTest("decimal", 30, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='decimal'>12345.6789<\/p>"
        );

        var answerData = Khan.answerTypes.decimal.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "", "empty", "empty answer is empty");
        testAnswer(answerData, "12345.6788", "wrong", "wrong answer is wrong");
        testAnswer(answerData, "12345.6789", "right", "right answer is right");
        testAnswer(answerData, "12345,6789", "right", "right answer with decimal comma is right");
        testAnswer(answerData, "12,345.6789", "right", "right answer with commas is right");
        testAnswer(answerData, "12,345.678,9", "right", "right answer with commas is right");
        testAnswer(answerData, "12.345,6789", "right", "right answer with periods is right");
        testAnswer(answerData, "12.345,678.9", "right", "right answer with periods is right");
        testAnswer(answerData, "12 345.678 9", "right", "right answer with spaces is right");
        testAnswer(answerData, "12 345,678 9", "right", "right answer with spaces is right");

        start();
    });

    asyncTest("number generic 0", 12, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution'>0<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "", "empty", "empty answer is empty");
        testAnswer(answerData, "42", "wrong", "wrong answer is wrong");
        testAnswer(answerData, "0", "right", "right answer is right");
        testAnswer(answerData, "0.0", "right", "right answer is right");

        start();
    });

    asyncTest("number generic 1/3", 12, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution'>0.3333333333333333<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "-1/3", "wrong", "wrong answer is wrong");
        testAnswer(answerData, "1/3", "right", "right answer is right");
        testAnswer(answerData, "2/6", "empty-message", "unsimplified right answer provides a message");
        testAnswer(answerData, "0.3333333333333333", "wrong", "decimal from calculator is wrong");

        start();
    });

    asyncTest("number generic -1.5", 15, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution'>-1.5<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "1.5", "wrong", "wrong answer is wrong");
        testAnswer(answerData, "-1.5", "right", "right answer is right");
        testAnswer(answerData, "-1,5000", "right", "right answer is right");
        testAnswer(answerData, "-3/2", "right", "right answer is right");
        testAnswer(answerData, "-6/4", "empty-message", "unsimplified right answer provides a message");

        start();
    });

    asyncTest("number generic 41976", 12, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution'>41976<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "419.76", "wrong", "wrong answer is wrong");
        testAnswer(answerData, "41976", "right", "right answer is right");
        testAnswer(answerData, "41,976", "right", "right answer with comma is right");
        testAnswer(answerData, "41.976", "right", "right answer with period is right");

        start();
    });

    asyncTest("multiple", 21, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='multiple'>" +
                "<span class='sol'>7<\/span>" +
                "<span class='sol'>1.5<\/span>" +
            "<\/p>"
        );

        var answerData = Khan.answerTypes.multiple.setup($("#solutionarea"),
                $problem.children(".solution"));

        testMultipleAnswer(answerData, ["7", "3/2"], "right", "right answer is right");
        testMultipleAnswer(answerData, ["7", "1.5"], "right", "right answer is right");
        testMultipleAnswer(answerData, ["3/2", "7"], "wrong", "wrong answer is wrong");
        testMultipleAnswer(answerData, ["7", ""], "wrong", "incomplete answer is wrong");
        testMultipleAnswer(answerData, ["", "3/2"], "wrong", "incomplete answer is wrong");
        testMultipleAnswer(answerData, ["", ""], "empty", "empty answer is empty");
        testMultipleAnswer(answerData, ["7", "6/4"], "empty-message", "unsimplified right answer provides a message");

        start();
    });

    asyncTest("multiple with fallback 1", 21, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='multiple'>" +
                "<span class='sol'>7<\/span>" +
                "<span class='sol' data-fallback='1'>1<\/span>" +
            "<\/p>"
        );

        var answerData = Khan.answerTypes.multiple.setup($("#solutionarea"),
                $problem.children(".solution"));

        testMultipleAnswer(answerData, ["7", "1"], "right", "right answer is right");
        testMultipleAnswer(answerData, ["1", "7"], "wrong", "wrong answer is wrong");
        testMultipleAnswer(answerData, ["7", "2"], "wrong", "wrong answer is wrong");
        testMultipleAnswer(answerData, ["7", ""], "right", "right answer is right");
        testMultipleAnswer(answerData, ["", "1"], "wrong", "incomplete answer is wrong");
        testMultipleAnswer(answerData, ["", "2"], "wrong", "incomplete answer is wrong");
        testMultipleAnswer(answerData, ["", ""], "empty", "empty answer is empty");

        start();
    });

    asyncTest("multiple with fallback 0", 21, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='multiple'>" +
                "<span class='sol'>7<\/span>" +
                "<span class='sol' data-fallback='0'>0<\/span>" +
            "<\/p>"
        );

        var answerData = Khan.answerTypes.multiple.setup($("#solutionarea"),
                $problem.children(".solution"));

        testMultipleAnswer(answerData, ["7", "0"], "right", "right answer is right");
        testMultipleAnswer(answerData, ["0", "7"], "wrong", "wrong answer is wrong");
        testMultipleAnswer(answerData, ["7", "2"], "wrong", "wrong answer is wrong");
        testMultipleAnswer(answerData, ["7", ""], "right", "right answer is right");
        testMultipleAnswer(answerData, ["", "0"], "wrong", "incomplete answer is wrong");
        testMultipleAnswer(answerData, ["", "2"], "wrong", "incomplete answer is wrong");
        testMultipleAnswer(answerData, ["", ""], "empty", "empty answer is empty");

        start();
    });

    asyncTest("multiple with coefficient +1", 18, function() {
        var forms = "integer, proper, improper, mixed, decimal, coefficient";

        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='multiple'>" +
                "<span class='sol' data-forms='" + forms + "'>7<\/span> x + " +
                "<span class='sol' data-forms='" + forms + "'>1<\/span> y" +
            "<\/p>"
        );

        var answerData = Khan.answerTypes.multiple.setup($("#solutionarea"),
                $problem.children(".solution"));

        testMultipleAnswer(answerData, ["7", "1"], "right", "right answer is right");
        testMultipleAnswer(answerData, ["1", "7"], "wrong", "wrong answer is wrong");
        testMultipleAnswer(answerData, ["7", "2"], "wrong", "wrong answer is wrong");
        testMultipleAnswer(answerData, ["7", ""], "right", "right answer is right");
        testMultipleAnswer(answerData, ["", "2"], "wrong", "incomplete answer is wrong");
        testMultipleAnswer(answerData, ["", ""], "empty", "empty answer is empty");

        start();
    });

    asyncTest("multiple with coefficient -1", 21, function() {
        var forms = "integer, proper, improper, mixed, decimal, coefficient";

        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='multiple'>" +
                "<span class='sol' data-forms='" + forms + "'>7<\/span> x + " +
                "<span class='sol' data-forms='" + forms + "'>-1<\/span> y" +
            "<\/p>"
        );

        var answerData = Khan.answerTypes.multiple.setup($("#solutionarea"),
                $problem.children(".solution"));

        testMultipleAnswer(answerData, ["7", "-1"], "right", "right answer is right");
        testMultipleAnswer(answerData, ["-1", "7"], "wrong", "wrong answer is wrong");
        testMultipleAnswer(answerData, ["7", "2"], "wrong", "wrong answer is wrong");
        testMultipleAnswer(answerData, ["7", "-"], "right", "right answer is right");
        testMultipleAnswer(answerData, ["7", ""], "wrong", "incomplete answer is wrong");
        testMultipleAnswer(answerData, ["", "2"], "wrong", "incomplete answer is wrong");
        testMultipleAnswer(answerData, ["", ""], "empty", "empty answer is empty");

        start();
    });

    asyncTest("multiple with two coefficients of 1", 15, function() {
        var forms = "integer, proper, improper, mixed, decimal, coefficient";

        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='multiple'>" +
                "<span class='sol' data-forms='" + forms + "'>1<\/span> x + " +
                "<span class='sol' data-forms='" + forms + "'>1<\/span> y" +
            "<\/p>"
        );

        var answerData = Khan.answerTypes.multiple.setup($("#solutionarea"),
                $problem.children(".solution"));

        testMultipleAnswer(answerData, ["1", "1"], "right", "right answer is right");
        testMultipleAnswer(answerData, ["1", ""], "right", "right answer is right");
        testMultipleAnswer(answerData, ["1", " "], "right", "right answer is right");
        testMultipleAnswer(answerData, ["", "1"], "right", "right answer is right");
        testMultipleAnswer(answerData, ["", ""], "empty", "empty answer is empty");

        start();
    });

    asyncTest("multiple with true checkbox", 12, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='multiple'>" +
                // Doing data-text here so that '' grades true; `set` will
                // behave similarly
                "<span class='sol' data-type='text'><\/span>" +
                "<span class='sol' data-type='checkbox'>true<\/span>" +
            "<\/p>"
        );

        var answerData = Khan.answerTypes.multiple.setup($("#solutionarea"),
                $problem.children(".solution"));

        testMultipleAnswer(answerData, ["", true], "right", "right answer is right");
        testMultipleAnswer(answerData, ["", false], "empty", "empty answer is empty");
        testMultipleAnswer(answerData, ["7", false], "wrong", "wrong answer is wrong");
        testMultipleAnswer(answerData, ["7", true], "wrong", "wrong answer is wrong");

        start();
    });

    asyncTest("multiple with false checkbox", 12, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='multiple'>" +
                "<span class='sol'>12<\/span>" +
                "<span class='sol' data-type='checkbox'>false<\/span>" +
            "<\/p>"
        );

        var answerData = Khan.answerTypes.multiple.setup($("#solutionarea"),
                $problem.children(".solution"));

        testMultipleAnswer(answerData, ["12", false], "right", "right answer is right");
        testMultipleAnswer(answerData, ["", false], "empty", "empty answer is empty");
        testMultipleAnswer(answerData, ["", true], "wrong", "wrong answer is wrong");
        testMultipleAnswer(answerData, ["12", true], "wrong", "nonsensical answer is wrong");

        start();
    });

    asyncTest("set with no things", 15, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<div class='solution' data-type='set'>" +
                "<div class='input-format'>" +
                    "<span class='entry'></span>" +
                    "<span class='entry'></span>" +
                "<\/div>" +
            "<\/div>"
        );

        var answerData = Khan.answerTypes.set.setup($("#solutionarea"),
                $problem.children(".solution"));

        // One of the few cases where we intentionally a validation result
        // something for an empty-looking answer; whenever this happens
        // there'll be a separate checkbox for "No solution" or something
        // similar as there is in absolute_value_equations
        testMultipleAnswer(answerData, ["", ""], "right", "right answer is right");
        testMultipleAnswer(answerData, ["3", ""], "wrong", "wrong answer is wrong");
        testMultipleAnswer(answerData, ["", "3"], "wrong", "wrong answer is wrong");
        testMultipleAnswer(answerData, ["12", "4"], "wrong", "wrong answer is wrong");
        testMultipleAnswer(answerData, ["4", "12"], "wrong", "wrong answer is wrong");

        start();
    });

    asyncTest("set with fewer things", 21, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<div class='solution' data-type='set'>" +
                "<span class='set-sol'>12<\/span>" +
                "<div class='input-format'>" +
                    "<span class='entry'></span>" +
                    "<span class='entry'></span>" +
                "<\/div>" +
            "<\/div>"
        );

        var answerData = Khan.answerTypes.set.setup($("#solutionarea"),
                $problem.children(".solution"));

        testMultipleAnswer(answerData, ["12", ""], "right", "right answer is right");
        testMultipleAnswer(answerData, ["", "12"], "right", "right answer is right");
        testMultipleAnswer(answerData, ["", ""], "empty", "empty answer is empty");
        testMultipleAnswer(answerData, ["3", ""], "wrong", "wrong answer is wrong");
        testMultipleAnswer(answerData, ["", "3"], "wrong", "wrong answer is wrong");
        testMultipleAnswer(answerData, ["12", "4"], "wrong", "wrong answer is wrong");
        testMultipleAnswer(answerData, ["4", "12"], "wrong", "wrong answer is wrong");

        start();
    });

    asyncTest("set with as many things", 24, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<div class='solution' data-type='set'>" +
                "<span class='set-sol'>12<\/span>" +
                "<span class='set-sol'>13<\/span>" +
                "<div class='input-format'>" +
                    "<span class='entry'></span>" +
                    "<span class='entry'></span>" +
                "<\/div>" +
            "<\/div>"
        );

        var answerData = Khan.answerTypes.set.setup($("#solutionarea"),
                $problem.children(".solution"));

        testMultipleAnswer(answerData, ["12", "13"], "right", "right answer is right");
        testMultipleAnswer(answerData, ["13", "12"], "right", "right answer is right");
        testMultipleAnswer(answerData, ["12", ""], "wrong", "incomplete answer is wrong");
        testMultipleAnswer(answerData, ["13", ""], "wrong", "incomplete answer is wrong");
        testMultipleAnswer(answerData, ["", "12"], "wrong", "incomplete answer is wrong");
        testMultipleAnswer(answerData, ["", ""], "empty", "empty answer is empty");
        testMultipleAnswer(answerData, ["12", "14"], "wrong", "wrong answer is wrong");
        testMultipleAnswer(answerData, ["12", "12"], "wrong", "wrong answer is wrong");

        start();
    });

    asyncTest("set with more things", 36, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<div class='solution' data-type='set'>" +
                "<span class='set-sol'>12<\/span>" +
                "<span class='set-sol'>13<\/span>" +
                "<span class='set-sol'>14<\/span>" +
                "<div class='input-format'>" +
                    "<span class='entry'></span>" +
                    "<span class='entry'></span>" +
                "<\/div>" +
            "<\/div>"
        );

        var answerData = Khan.answerTypes.set.setup($("#solutionarea"),
                $problem.children(".solution"));

        testMultipleAnswer(answerData, ["12", "13"], "right", "right answer is right");
        testMultipleAnswer(answerData, ["12", "14"], "right", "right answer is right");
        testMultipleAnswer(answerData, ["13", "12"], "right", "right answer is right");
        testMultipleAnswer(answerData, ["13", "14"], "right", "right answer is right");
        testMultipleAnswer(answerData, ["14", "12"], "right", "right answer is right");
        testMultipleAnswer(answerData, ["14", "13"], "right", "right answer is right");
        testMultipleAnswer(answerData, ["12", ""], "wrong", "incomplete answer is wrong");
        testMultipleAnswer(answerData, ["13", ""], "wrong", "incomplete answer is wrong");
        testMultipleAnswer(answerData, ["", "12"], "wrong", "incomplete answer is wrong");
        testMultipleAnswer(answerData, ["", ""], "empty", "empty answer is empty");
        testMultipleAnswer(answerData, ["12", "12"], "wrong", "wrong answer is wrong");
        testMultipleAnswer(answerData, ["12", "7"], "wrong", "wrong answer is wrong");

        start();
    });

    asyncTest("radio answerability", 8, function() {
        // TODO(alpert): Get rid of MathJax
        Exercises.useKatex = false;

        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution'><code>6<\/code><\/p>" +
            "<ul class='choices'>" +
                "<li><code>21<\/code><\/li>" +
                "<li><code>25<\/code><\/li>" +
                "<li><code>27<\/code><\/li>" +
                "<li><code>37<\/code><\/li>" +
            "<\/ul>"
        );
        jQuery("#qunit-fixture").runModules();

        var $solutionarea = $("#solutionarea");
        var $solution = $problem.children(".solution");

        // TOOD(alpert): Why is this Queue necessary? Everything happens
        // synchronously in the real site and it seems to work fine there.
        // Here, if we skip the Queue then answerData is false because the
        // radio setup function doesn't seem to think there's any text in any
        // of the choices (and thus that they're all the same choice).
        MathJax.Hub.Queue(function() {
            var answerData = Khan.answerTypes.radio.setup(
                    $solutionarea, $solution);

            var validator = answerData.validator;
            var getAnswer = answerData.answer;

            // By default, nothing is checked so the validator gives ""
            strictEqual(validator(getAnswer()).empty, true, "initial validation is empty");

            // Each answer should have a non-empty MathJax script tag
            $("#solutionarea script").each(function() {
                ok((/\S/).test($(this).html()));
            });

            // If we check the right answer (6), then it'll return true
            var $correctRadio = $("#solutionarea script")
                .filter(function() { return (/6/).test($(this).html()); })
                .closest("label").children("input");
            $correctRadio.prop("checked", true);

            strictEqual(validator(getAnswer()).correct, true);

            // If we check a wrong answer, then it'll return false
            var $incorrectRadio = $("#solutionarea script")
                .filter(function() { return !(/6/).test($(this).html()); })
                .closest("label").children("input");
            $incorrectRadio.prop("checked", true);
            strictEqual(validator(getAnswer()).correct, false);

            // Tell QUnit we're done.
            start();
        });
    });

    asyncTest("radio category", 4, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution'>C<\/p>" +
            "<ul class='choices' data-category='true'>" +
                "<li>A<\/li>" +
                "<li>B<\/li>" +
                "<li>C<\/li>" +
                "<li>D<\/li>" +
            "<\/ul>"
        );
        jQuery("#qunit-fixture").runModules();

        var $solutionarea = $("#solutionarea");
        var $solution = $problem.children(".solution");

        var answerData = Khan.answerTypes.radio.setup(
                $solutionarea, $solution);

        var validator = answerData.validator;
        var getAnswer = answerData.answer;

        // By default, nothing is checked so the validator gives ""
        strictEqual(validator(getAnswer()).empty, true, "initial validation is empty");

        var texts = _.map($("#solutionarea span.value"), function(e) {
            return $(e).text();
        });
        deepEqual(texts, ["A", "B", "C", "D"], "choices have the right order");

        // If we check the right answer (C), then it'll return true
        var $correctRadio = $("#solutionarea span.value")
            .filter(function() { return (/C/).test($(this).html()); })
            .closest("label").children("input");
        $correctRadio.prop("checked", true);

        strictEqual(validator(getAnswer()).correct, true);

        // If we check a wrong answer, then it'll return false
        var $incorrectRadio = $("#solutionarea span.value")
            .filter(function() { return (/A/).test($(this).html()); })
            .closest("label").children("input");
        $incorrectRadio.prop("checked", true);
        strictEqual(validator(getAnswer()).correct, false);

        start();
    });

    asyncTest("radio setup", 24, function() {
        var choices = ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K"];

        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution'>C<\/p>" +
            "<ul class='choices' data-show='11'>" +
                _.map(choices, function(choice) {
                    return "<li>" + choice + "<\/li>";
                }).join("") +
            "<\/ul>"
        );
        jQuery("#qunit-fixture").runModules();

        var $solutionarea = $("#solutionarea");
        var $solution = $problem.children(".solution");

        var answerData = Khan.answerTypes.radio.setup(
                $solutionarea, $solution);

        var texts = _.map($("#solutionarea span.value"), function(e) {
            return $(e).text();
        });

        strictEqual(texts.length, choices.length,
            "The number of choices should be correct");
        _.each(texts, function(text) {
            ok(_.contains(choices, text),
                "The text should be one of the provided choices")
        });

        var textCounts = _.countBy(texts);
        _.each(textCounts, function(count) {
            strictEqual(count, 1, "There should only be one of each choice");
        });

        // This can fail rarely, if the results were shuffled back into the
        // original order, but that is unlikely
        notDeepEqual(["C", "A", "B", "D", "E", "F", "G", "H", "I", "J", "K"],
            texts, "The results were shuffled");

        start();
    });

    asyncTest("radio none of the above setup", 2, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution'>A<\/p>" +
            "<ul class='choices' data-none='true'>" +
                "<li>B<\/li>" +
                "<li>C<\/li>" +
                "<li>D<\/li>" +
            "<\/ul>"
        );
        jQuery("#qunit-fixture").runModules();

        var $solutionarea = $("#solutionarea");
        var $solution = $problem.children(".solution");

        var answerData = Khan.answerTypes.radio.setup(
                $solutionarea, $solution);

        var texts = _.map($("#solutionarea span.value"), function(e) {
            return $(e).text();
        });

        strictEqual(texts.length, 4, "The number of choices should be correct");
        strictEqual(texts[3], "None of the above.",
            "The last choice should be none of the above");

        start();
    });

    asyncTest("radio none of the above setup 2", 2, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution'>A<\/p>" +
            "<ul class='choices' data-none='true' data-show='5'>" +
                "<li>B<\/li>" +
                "<li>C<\/li>" +
                "<li>D<\/li>" +
            "<\/ul>"
        );
        jQuery("#qunit-fixture").runModules();

        var $solutionarea = $("#solutionarea");
        var $solution = $problem.children(".solution");

        var answerData = Khan.answerTypes.radio.setup(
                $solutionarea, $solution);

        var texts = _.map($("#solutionarea span.value"), function(e) {
            return $(e).text();
        });

        strictEqual(texts.length, 5, "The number of choices should be correct");
        strictEqual(texts[4], "None of the above.",
            "The last choice should be none of the above");

        start();
    });

    asyncTest("radio none of the above answerability", 4, function() {
        // Even if there are 500 distractors, the correct answer must always be
        // mixed in as one of the correct ones -- we'll test that if there's
        // only answer and we show "None of the above", then it's hiding the
        // correct answer. (This test can pass even if the code is buggy 1/501
        // of the time, but we'll have to live with that.)
        var choices = _.range(500);
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution'>A<\/p>" +
            "<ul class='choices' data-none='true' data-show='1'>" +
                _.map(choices, function(choice) {
                    return "<li>" + choice + "<\/li>";
                }).join("") +
            "<\/ul>"
        );
        jQuery("#qunit-fixture").runModules();

        var $solutionarea = $("#solutionarea");
        var $solution = $problem.children(".solution");

        var answerData = Khan.answerTypes.radio.setup(
                $solutionarea, $solution);

        var validator = answerData.validator;
        var getAnswer = answerData.answer;

        var texts = _.map($("#solutionarea span.value"), function(e) {
            return $(e).text();
        });

        deepEqual(texts, ["None of the above."],
            "The only choice should be none of the above");

        // By default, nothing is checked so the validator gives ""
        strictEqual(validator(getAnswer()).empty, true, "initial validation is empty");

        // If we check the right answer (C), then it'll return true
        var $correctRadio = $("#solutionarea span.value").first()
            .closest("label").children("input");
        $correctRadio.prop("checked", true);

        // Make sure the answer gets marked as correct
        strictEqual(validator(getAnswer()).correct, true);

        // Now, wait for the animation to wear off...
        setTimeout(function() {
            // Make sure that the correct solution is now shown
            var newText = $("#solutionarea span.value").first().text();
            strictEqual(newText, "A",
                "The correct text appears after the answer is selected");

            start();
        }, 400);
    });

})();
</script>

</body>
</html>
