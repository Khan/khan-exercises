<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>answer-types</title>
    <!-- Include dependencies -->
    <script src="../../jquery.js"></script>
    <script>
        // TODO(alpert): Ugh, should probably load khan-exercise.js for real...
        var Khan = {
            query: {},
            scriptWait: $.noop,

            // This is a random number pulled out of my 32-bit
            // pseudo-random hat so that tests are always the same
            randomSeed: 0x4e27b400
        };
        var KhanUtil = Khan.Util = {
            debugLog: $.noop,
            random: function() {
                // Robert Jenkins' 32 bit integer hash function.
                var seed = Khan.randomSeed;
                seed = ((seed + 0x7ed55d16) + (seed << 12)) & 0xffffffff;
                seed = ((seed ^ 0xc761c23c) ^ (seed >>> 19)) & 0xffffffff;
                seed = ((seed + 0x165667b1) + (seed << 5)) & 0xffffffff;
                seed = ((seed + 0xd3a2646c) ^ (seed << 9)) & 0xffffffff;
                seed = ((seed + 0xfd7046c5) + (seed << 3)) & 0xffffffff;
                seed = ((seed ^ 0xb55a4f09) ^ (seed >>> 16)) & 0xffffffff;
                return (Khan.randomSeed = (seed & 0xfffffff)) / 0x10000000;
            }
        };
        $.fn.runModules = function() { $.fn.tmpl.apply(this, arguments); };
    </script>
    <script src="../underscore.js"></script>
    <script src="../MathJax/2.1/MathJax.js?config=KAthJax-da9a7f53e588f3837b045a600e1dc439"></script>

    <!-- Include QUnit -->
    <link rel="stylesheet" href="../../test/qunit/qunit/qunit.css" type="text/css" media="screen">
    <script src="../../test/qunit/qunit/qunit.js"></script>

    <!-- Include utility files and tests. -->
    <script src="../math.js"></script>
    <script src="../tmpl.js"></script>
    <script src="../answer-types.js"></script>
</head>
<body>

<h1 id="qunit-header">answer-types</h1>
<h2 id="qunit-banner"></h2>
<div id="qunit-testrunner-toolbar"></div>
<h2 id="qunit-userAgent"></h2>
<ol id="qunit-tests"></ol>

<div id="qunit-fixture">
    <div id="solutionarea">
    </div>
    <div class="problem">
    </div>
</div>

<script>
(function() {

    /**
     * Return a promise that gets resolved after 1 ms
     */
    function defer() {
        var deferred = $.Deferred();
        _.defer(deferred.resolve);
        return deferred.promise();
    }

    function testAnswer(answerData, input, result, description) {
        $("#solutionarea input").val(input);
        checkAnswer(answerData, result, description + " [" + input + "]");
    }

    function testMultipleAnswer(answerData, inputs, result, description) {
        _.chain($("#solutionarea input")).zip(inputs).each(function(args) {
            var el = args[0], text = args[1];
            $(el).val(text);
        });
        checkAnswer(
            answerData, result, description + " [" + inputs.join(", ") + "]");
    }

    function checkAnswer(answerData, result, description) {
        var validator = answerData.validator;
        var getAnswer = answerData.answer;

        if (result === "string") {  // literally, the string "string"
            strictEqual(typeof validator(getAnswer()), "string", description);
        } else {
            strictEqual(validator(getAnswer()), result, description);
        }
    }

    asyncTest("number integer", 7, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='number' data-forms='integer'>-42<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "123", false, "wrong answer is wrong");
        testAnswer(answerData, "-42", true, "right answer is right");
        testAnswer(answerData, "-84/2", false, "non-integer right answer is wrong");
        testAnswer(answerData, " \u2212 42 ", true, "weirdly formatted right answer is right");
        testAnswer(answerData, "- 4 2", false, "crazily formatted answer is wrong");
        testAnswer(answerData, "-41.9999999", false, "close decimal is wrong");
        testAnswer(answerData, "-,42", false, "sort of tricky wrong answer is wrong");

        start();
    });

    asyncTest("number big integer", 6, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='number' data-forms='integer'>12345678<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "12345670", false, "wrong answer is wrong");
        testAnswer(answerData, "12345678", true, "right answer is right");
        testAnswer(answerData, "12,345,678", true, "right answer with commas is right");
        testAnswer(answerData, "12.345.678", true, "right answer with periods is right");
        testAnswer(answerData, "12 345 678", true, "right answer with spaces is right");
        testAnswer(answerData, "123 45 678", false, "right answer with wrong commas is wrong");

        start();
    });

    asyncTest("number proper", 5, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='number' data-forms='proper'>-0.5<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "1/2", false, "wrong answer is wrong");
        testAnswer(answerData, "-1/2", true, "right answer is right");
        testAnswer(answerData, "-2/4", "string", "unsimplified right answer provides a message");
        testAnswer(answerData, " \u2212 1 / 2 ", true, "weirdly formatted right answer is right");
        testAnswer(answerData, "-0.5", false, "decimal is wrong");

        start();
    });

    asyncTest("number proper (unsimplified)", 5, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='number' data-forms='proper' " +
            "data-simplify='optional'>-0.5<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "1/2", false, "wrong answer is wrong");
        testAnswer(answerData, "-1/2", true, "right answer is right");
        testAnswer(answerData, "-2/4", true, "unsimplified right answer is right");
        testAnswer(answerData, " \u2212 1 / 2 ", true, "weirdly formatted right answer is right");
        testAnswer(answerData, "-0.5", false, "decimal is wrong");

        start();
    });

    asyncTest("number improper", 6, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='number' data-forms='improper'>-1.5<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "3/2", false, "wrong answer is wrong");
        testAnswer(answerData, "-3/2", true, "right answer is right");
        testAnswer(answerData, "-6/4", "string", "unsimplified right answer provides a message");
        testAnswer(answerData, " \u2212 3 / 2 ", true, "weirdly formatted right answer is right");
        testAnswer(answerData, "-1.5", false, "decimal is wrong");
        testAnswer(answerData, "-1 1/2", false, "mixed number is wrong");

        start();
    });

    asyncTest("number improper (unsimplified)", 6, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='number' data-forms='improper' " +
            "data-simplify='optional'>-1.5<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "3/2", false, "wrong answer is wrong");
        testAnswer(answerData, "-3/2", true,  "right answer is right");
        testAnswer(answerData, "-6/4", true,  "unsimplified right answer is right");
        testAnswer(answerData, " \u2212 3 / 2 ", true,  "weirdly formatted right answer is right");
        testAnswer(answerData, "-1.5", false, "decimal is wrong");
        testAnswer(answerData, "-1 1/2", false, "mixed number is wrong");

        start();
    });

    asyncTest("number pi", 10, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='number' data-forms='pi'>-6.283185307179586<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "2pi", false, "wrong answer is wrong");
        testAnswer(answerData, "-2pi", true, "right answer is right");
        testAnswer(answerData, "-tau", true, "right answer is right");
        testAnswer(answerData, "-2tau", false, "tau is not pi");
        testAnswer(answerData, "-2", false, "pi is not 1");
        testAnswer(answerData, "-6.28", "string", "approximately right answer provides a message");
        testAnswer(answerData, "-44/7", "string", "approximately right answer provides a message");
        testAnswer(answerData, "" + (-2 * Math.PI), "string", "approximately right answer provides a message");
        testAnswer(answerData, "-2/1 pi", "string", "unsimplified answer provides a message");
        testAnswer(answerData, "-9.42", false, "totally wrong answer gives no message");

        start();
    });

    asyncTest("number pi (rational)", 14, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='number' data-forms='pi'>-2.6179938779914944<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "5pi/6", false, "wrong answer is wrong");
        testAnswer(answerData, "-5/6pi", true, "right answer is right");
        testAnswer(answerData, "-5/12tau", true, "right answer is right");
        testAnswer(answerData, "-5pi/6", true, "right answer is right");
        testAnswer(answerData, "-5tau/12", true, "right answer is right");
        testAnswer(answerData, "-2.62", "string", "approximately right answer provides a message");
        testAnswer(answerData, " \u2212 5 \u03c0 / 6 ", true, "weirdly formatted right answer is right");
        testAnswer(answerData, " \u2212 5 \u03c4 / 12 ", true, "weirdly formatted right answer is right");
        testAnswer(answerData, " 5 \u03c0 / \u2212 6 ", "string", "negative in denominator provides a message");
        testAnswer(answerData, " 5 \u03c4 / \u2212 12 ", "string", "negative in denominator provides a message");
        testAnswer(answerData, " \u2212 5 / 6 \u03c0 ", true, "weirdly formatted right answer is right");
        testAnswer(answerData, " \u2212 5 / 12 \u03c4 ", true, "weirdly formatted right answer is right");
        testAnswer(answerData, " 5 / \u2212 6 \u03c0 ", "string", "negative in denominator provides a message");
        testAnswer(answerData, " 5 / \u2212 12 \u03c4 ", "string", "negative in denominator provides a message");

        start();
    });

    asyncTest("number pi (rational > 1)", 7, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='number' data-forms='pi'>-15.184364492350666<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "4 5pi/6", false, "wrong answer is wrong");
        testAnswer(answerData, "-4 5/6pi", true, "right answer is right");
        testAnswer(answerData, "-29/6pi", true, "right answer is right");
        testAnswer(answerData, "-2 5/12tau", true, "right answer is right");
        testAnswer(answerData, "-15.18", "string", "approximately right answer provides a message");
        testAnswer(answerData, " \u2212 4 5 / 6 \u03c0 ", true, "weirdly formatted right answer is right");
        testAnswer(answerData, " \u2212 2 5 / 12 \u03c4 ", true, "weirdly formatted right answer is right");

        start();
    });

    asyncTest("number pi (decimal)", 6, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='number' data-forms='pi'>-1.5707963267948966<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "0.5 pi", false, "wrong answer is wrong");
        testAnswer(answerData, "-0.5pi", true, "right answer is right");
        testAnswer(answerData, "-0.25tau", true, "right answer is right");
        testAnswer(answerData, "-1.57", "string", "approximately right answer provides a message");
        testAnswer(answerData, " \u2212 0.5 \u03c0 ", true, "weirdly formatted right answer is right");
        testAnswer(answerData, " \u2212 0.25 \u03c4 ", true, "weirdly formatted right answer is right");

        start();
    });

    asyncTest("number log", 3, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='number' data-forms='log'>2<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "2", false, "wrong answer is wrong");
        testAnswer(answerData, "log(2)", true, "right answer is right");
        testAnswer(answerData, " log ( 2 ) ", true, "weirdly formatted right answer is right");

        start();
    });

    asyncTest("number percent", 3, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='number' data-forms='percent'>0.42<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "0.42", false, "wrong answer is wrong");
        testAnswer(answerData, "42%", true, "right answer is right");
        testAnswer(answerData, "42", "string", "leaving off percent sign provides a message");

        start();
    });

    asyncTest("number dollar", 6, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='number' data-forms='dollar'>1.42<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "1.40", false, "wrong answer is wrong");
        testAnswer(answerData, "$1.42", true, "right answer is right");
        testAnswer(answerData, "1.42", true, "right answer is right without dollar sign");
        testAnswer(answerData, " $ 1.42 ", true, "weirdly formatted right answer is right");

        testAnswer(answerData, "$1.42$", false, "two dollar signs is wrong");
        // TODO(alpert): wtf?
        testAnswer(answerData, "1.4$2", true, "one dollar sign can be anywhere");

        start();
    });

    asyncTest("number mixed", 6, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='number' data-forms='mixed'>-1.5<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "1 1/2", false, "wrong answer is wrong");
        testAnswer(answerData, "-1 1/2", true, "right answer is right");
        testAnswer(answerData, "-1 2/4", "string", "unsimplified right answer provides a message");
        testAnswer(answerData, " \u2212 1 1 / 2 ", true, "weirdly formatted right answer is right");
        testAnswer(answerData, "-1.5", false, "decimal is wrong");
        testAnswer(answerData, "-3/2", false, "improper fraction is wrong");

        start();
    });

    asyncTest("number mixed (unsimplified)", 6, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='number' data-forms='mixed' " +
            "data-simplify='optional'>-1.5<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "1 1/2", false, "wrong answer is wrong");
        testAnswer(answerData, "-1 1/2", true,  "right answer is right");
        testAnswer(answerData, "-1 2/4", true,  "unsimplified right answer is right");
        testAnswer(answerData, " \u2212 1 1 / 2 ", true,  "weirdly formatted right answer is right");
        testAnswer(answerData, "-1.5", false, "decimal is wrong");
        testAnswer(answerData, "-3/2", false, "improper fraction is wrong");

        start();
    });

    asyncTest("number decimal", 9, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='number' data-forms='decimal'>12345.6789<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "12345.6788", false, "wrong answer is wrong");
        testAnswer(answerData, "12345.6789", true, "right answer is right");
        testAnswer(answerData, "12345,6789", true, "right answer with decimal comma is right");
        testAnswer(answerData, "12,345.6789", true, "right answer with commas is right");
        testAnswer(answerData, "12,345.678,9", true, "right answer with commas is right");
        testAnswer(answerData, "12.345,6789", true, "right answer with periods is right");
        testAnswer(answerData, "12.345,678.9", true, "right answer with periods is right");
        testAnswer(answerData, "12 345.678 9", true, "right answer with spaces is right");
        testAnswer(answerData, "12 345,678 9", true, "right answer with spaces is right");

        start();
    });

    asyncTest("decimal", 9, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='decimal'>12345.6789<\/p>"
        );

        var answerData = Khan.answerTypes.decimal.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "12345.6788", false, "wrong answer is wrong");
        testAnswer(answerData, "12345.6789", true, "right answer is right");
        testAnswer(answerData, "12345,6789", true, "right answer with decimal comma is right");
        testAnswer(answerData, "12,345.6789", true, "right answer with commas is right");
        testAnswer(answerData, "12,345.678,9", true, "right answer with commas is right");
        testAnswer(answerData, "12.345,6789", true, "right answer with periods is right");
        testAnswer(answerData, "12.345,678.9", true, "right answer with periods is right");
        testAnswer(answerData, "12 345.678 9", true, "right answer with spaces is right");
        testAnswer(answerData, "12 345,678 9", true, "right answer with spaces is right");

        start();
    });

    asyncTest("number generic 0", 3, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution'>0<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "42", false, "wrong answer is wrong");
        testAnswer(answerData, "0", true, "right answer is right");
        testAnswer(answerData, "0.0", true, "right answer is right");

        start();
    });

    asyncTest("number generic 1/3", 4, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution'>0.3333333333333333<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "-1/3", false, "wrong answer is wrong");
        testAnswer(answerData, "1/3", true, "right answer is right");
        testAnswer(answerData, "2/6", "string", "unsimplified right answer provides a message");
        testAnswer(answerData, "0.3333333333333333", false, "decimal from calculator is wrong");

        start();
    });

    asyncTest("number generic -1.5", 5, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution'>-1.5<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "1.5", false, "wrong answer is wrong");
        testAnswer(answerData, "-1.5", true, "right answer is right");
        testAnswer(answerData, "-1,5000", true, "right answer is right");
        testAnswer(answerData, "-3/2", true, "right answer is right");
        testAnswer(answerData, "-6/4", "string", "unsimplified right answer provides a message");

        start();
    });

    asyncTest("number generic 41976", 4, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution'>41976<\/p>"
        );

        var answerData = Khan.answerTypes.number.setup($("#solutionarea"),
                $problem.children(".solution"));

        testAnswer(answerData, "419.76", false, "wrong answer is wrong");
        testAnswer(answerData, "41976", true, "right answer is right");
        testAnswer(answerData, "41,976", true, "right answer with comma is right");
        testAnswer(answerData, "41.976", true, "right answer with period is right");

        start();
    });

    asyncTest("multiple", 4, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution' data-type='multiple'>" +
                "<span class='sol'>7<\/span>" +
                "<span class='sol'>1.5<\/span>" +
            "<\/p>"
        );

        var answerData = Khan.answerTypes.multiple.setup($("#solutionarea"),
                $problem.children(".solution"));

        testMultipleAnswer(answerData, ["7", "3/2"], true, "right answer is right");
        testMultipleAnswer(answerData, ["7", "1.5"], true, "right answer is right");
        testMultipleAnswer(answerData, ["3/2", "7"], false, "wrong answer is wrong");
        testMultipleAnswer(answerData, ["7", "6/4"], "string", "unsimplified right answer provides a message");

        start();
    });

    asyncTest("radio answerability", 8, function() {
        var $problem = jQuery("#qunit-fixture .problem").append(
            "<p class='solution'><code>6<\/code><\/p>" +
            "<ul class='choices'>" +
                "<li><code>21<\/code><\/li>" +
                "<li><code>25<\/code><\/li>" +
                "<li><code>27<\/code><\/li>" +
                "<li><code>37<\/code><\/li>" +
            "<\/ul>"
        );
        jQuery("#qunit-fixture").tmpl();

        var $solutionarea = $("#solutionarea");
        var $solution = $problem.children(".solution");

        // TOOD(alpert): Why is this Queue necessary? Everything happens
        // synchronously in the real site and it seems to work fine there.
        // Here, if we skip the Queue then answerData is false because the
        // radio setup function doesn't seem to think there's any text in any
        // of the choices (and thus that they're all the same choice).
        MathJax.Hub.Queue(function() {
            var answerData = Khan.answerTypes.radio.setup(
                    $solutionarea, $solution);

            var validator = answerData.validator;
            var getAnswer = answerData.answer;

            // By default, nothing is checked so the validator gives ""
            strictEqual(validator(getAnswer()), "", "initial validation is empty");

            // Each answer should have a non-empty MathJax script tag
            $("#solutionarea script").each(function() {
                ok((/\S/).test($(this).html()));
            });

            // If we check the right answer (6), then it'll return true
            var $correctRadio = $("#solutionarea script")
                .filter(function() { return (/6/).test($(this).html()); })
                .closest("label").children("input");
            $correctRadio.prop("checked", true);

            strictEqual(validator(getAnswer()), true);

            // If we check a wrong answer, then it'll return false
            var $incorrectRadio = $("#solutionarea script")
                .filter(function() { return !(/6/).test($(this).html()); })
                .closest("label").children("input");
            $incorrectRadio.prop("checked", true);
            strictEqual(validator(getAnswer()), false);

            // Tell QUnit we're done.
            start();
        });
    });

})();
</script>

</body>
</html>
